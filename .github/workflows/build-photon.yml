name: Build Photon

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'photon/**'
      - '.github/workflows/build-photon.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'photon/**'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build Photon - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: photon
            asset_name: photon-linux-x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: photon.exe
            asset_name: photon-windows-x86_64.exe
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact_name: photon
            asset_name: photon-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact_name: photon
            asset_name: photon-macos-aarch64

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: ${{ matrix.target }}

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}

    - name: Cache cargo build
      uses: actions/cache@v4
      with:
        path: photon/target
        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('**/Cargo.lock') }}

    - name: Build Photon
      working-directory: photon
      run: cargo build --release --target ${{ matrix.target }}

    - name: Run tests
      working-directory: photon
      run: cargo test --release --target ${{ matrix.target }}

    - name: Strip binary (Linux and macOS)
      if: matrix.os != 'windows-latest'
      working-directory: photon
      run: strip target/${{ matrix.target }}/release/${{ matrix.artifact_name }}

    - name: Rename binary
      working-directory: photon
      shell: bash
      run: |
        mkdir -p artifacts
        cp target/${{ matrix.target }}/release/${{ matrix.artifact_name }} artifacts/${{ matrix.asset_name }}

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.asset_name }}
        path: photon/artifacts/${{ matrix.asset_name }}
        if-no-files-found: error

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Get Photon version
      id: version
      working-directory: photon
      run: |
        VERSION=$(grep '^version = ' Cargo.toml | head -1 | cut -d'"' -f2)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Photon version: $VERSION"

    - name: Create build info
      run: |
        cat > build-info.txt << EOF
        Photon Build Information
        ========================
        Version: ${{ steps.version.outputs.version }}
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        Workflow: ${{ github.workflow }}
        Run Number: ${{ github.run_number }}
        
        Available Artifacts:
        - photon-linux-x86_64 (Linux x86_64)
        - photon-windows-x86_64.exe (Windows x86_64)
        - photon-macos-x86_64 (macOS Intel)
        - photon-macos-aarch64 (macOS Apple Silicon)
        
        Repository: ${{ github.repository }}
        Actor: ${{ github.actor }}
        EOF
        cat build-info.txt

    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info
        path: build-info.txt

  create-release-archive:
    name: Create Release Archive
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Display structure
      run: ls -R artifacts

    - name: Create combined archive
      run: |
        cd artifacts
        # Move binaries to root level
        find . -type f -name "photon*" -exec mv {} . \;
        # Remove empty directories
        find . -type d -empty -delete
        # Create archive
        tar -czf photon-all-platforms.tar.gz photon-*
        zip -r photon-all-platforms.zip photon-*

    - name: Upload combined archive (tar.gz)
      uses: actions/upload-artifact@v4
      with:
        name: photon-all-platforms-tar
        path: artifacts/photon-all-platforms.tar.gz

    - name: Upload combined archive (zip)
      uses: actions/upload-artifact@v4
      with:
        name: photon-all-platforms-zip
        path: artifacts/photon-all-platforms.zip
